

fluentd:
  name: fluentd
  image: fluent/fluentd-kubernetes-daemonset:v0.12-elasticsearch
  configFiles:
    fluent.conf: |
      @include kubernetes.conf
      # @include systemd.conf

      <match **>
        type elasticsearch
        log_level info
        include_tag_key true
        host "#{ENV['FLUENT_ELASTICSEARCH_HOST']}"
        port "#{ENV['FLUENT_ELASTICSEARCH_PORT']}"
        scheme "#{ENV['FLUENT_ELASTICSEARCH_SCHEME'] || 'http'}"
        user "#{ENV['FLUENT_ELASTICSEARCH_USER']}"
        password "#{ENV['FLUENT_ELASTICSEARCH_PASSWORD']}"
        logstash_format true
        buffer_chunk_limit 2M
        buffer_queue_limit 32
        flush_interval 5s
        max_retry_wait 30
        disable_retry_limit
        num_threads 8
      </match>
    kubernetes.conf: |
      <match fluent.**>
        type null
      </match>

      <source>
        type tail
        path /var/log/containers/*.log
        pos_file /var/log/fluentd-containers.log.pos
        time_format %Y-%m-%dT%H:%M:%S.%NZ
        tag kubernetes.*
        format json
        read_from_head true
      </source>

      <source>
        type tail
        format /^time="(?<time>[^)]*)" level=(?<severity>[^ ]*) msg="(?<message>[^"]*)"( err="(?<error>[^"]*)")?( statusCode=($<status_code>\d+))?/
        path /var/log/docker.log
        pos_file /var/log/fluentd-docker.log.pos
        tag docker
      </source>

      <source>
        type tail
        format none
        path /var/log/etcd.log
        pos_file /var/log/fluentd-etcd.log.pos
        tag etcd
      </source>

      <source>
        type tail
        format kubernetes
        multiline_flush_interval 5s
        path /var/log/kubelet.log
        pos_file /var/log/fluentd-kubelet.log.pos
        tag kubelet
      </source>

      <source>
        type tail
        format kubernetes
        multiline_flush_interval 5s
        path /var/log/kube-proxy.log
        pos_file /var/log/fluentd-kube-proxy.log.pos
        tag kube-proxy
      </source>

      <source>
        type tail
        format kubernetes
        multiline_flush_interval 5s
        path /var/log/kube-apiserver.log
        pos_file /var/log/fluentd-kube-apiserver.log.pos
        tag kube-apiserver
      </source>

      <source>
        type tail
        format kubernetes
        multiline_flush_interval 5s
        path /var/log/kube-controller-manager.log
        pos_file /var/log/fluentd-kube-controller-manager.log.pos
        tag kube-controller-manager
      </source>

      <source>
        type tail
        format kubernetes
        multiline_flush_interval 5s
        path /var/log/kube-scheduler.log
        pos_file /var/log/fluentd-kube-scheduler.log.pos
        tag kube-scheduler
      </source>

      <source>
        type tail
        format kubernetes
        multiline_flush_interval 5s
        path /var/log/glbc.log
        pos_file /var/log/fluentd-glbc.log.pos
        tag glbc
      </source>

      <filter kubernetes.**>
        type kubernetes_metadata
      </filter>
    systemd.conf: |
      # Logs from systemd-journal for interesting services.
      <source>
        @type systemd
        filters [{ "_SYSTEMD_UNIT": "kubelet.service" }]
        pos_file /var/log/fluentd-journald-kubelet.pos
        read_from_head true
        tag kubelet
      </source>


kibana:
  name: kibana
  image: blacktop/kibana:5.4
  replicas: 1
  serviceType: NodePort